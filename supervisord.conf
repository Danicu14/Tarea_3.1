# Configuración de Supervisor para manejar múltiples procesos
# Nginx + Gunicorn en un solo contenedor

[supervisord]
nodaemon=true                   # Correr en foreground (requerido por Docker)
user=root                       # Usuario (root para poder iniciar nginx)
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info

# ========================================
# NGINX - Servidor Web / Proxy Inverso
# ========================================

[program:nginx]
command=nginx -g "daemon off;"  # Nginx en foreground
autostart=true                  # Iniciar automáticamente
autorestart=true                # Reiniciar si falla
startretries=3                  # Intentos de reinicio
priority=10                     # Prioridad de inicio (antes que gunicorn)
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stopwaitsecs=10                 # Tiempo de espera para SIGTERM antes de SIGKILL
stopsignal=QUIT                 # Señal para terminar gracefully

# ========================================
# GUNICORN - Servidor de Aplicación
# ========================================

[program:gunicorn]
command=gunicorn -c /app/gunicorn.conf.py app.main:app
directory=/app                  # Directorio de trabajo
autostart=true
autorestart=true
startretries=3
priority=20                     # Iniciar después de nginx
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stopwaitsecs=30                 # Dar tiempo a terminar requests
stopsignal=TERM                 # SIGTERM para graceful shutdown

# Variables de entorno (opcional, se pueden pasar desde Docker)
environment=
    PYTHONUNBUFFERED="1",
    PYTHONDONTWRITEBYTECODE="1"

# ========================================
# SUPERVISORCTL - Interfaz de Control
# ========================================

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
